@model foro.Web.DTOs.TemaCreateDto

@{
    ViewData["Title"] = "Crear Nuevo Tema";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        .form-control:focus, .form-select:focus {
    border-color: #0d6efd;
   box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
 }

.is-invalid {
   border-color: #dc3545 !important;
   }

        .invalid-feedback {
     display: block;
   animation: shake 0.5s;
 }

     @@keyframes shake {
    0%, 100% { transform: translateX(0); }
       25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
        }

 .char-counter {
       transition: color 0.3s;
 }

   .char-counter.warning {
   color: #ffc107;
        }

  .char-counter.danger {
 color: #dc3545;
 font-weight: bold;
 }

  .preview-card {
      display: none;
 }
    </style>
}

<div class="container mt-4">
    <div class="row justify-content-center">
    <div class="col-lg-8">
  <!-- Encabezado -->
<div class="d-flex align-items-center mb-4">
  <a asp-action="Index" class="btn btn-outline-secondary me-3">
     <i class="bi bi-arrow-left"></i>
    </a>
     <div>
  <h1 class="display-6 mb-0">
      <i class="bi bi-plus-circle text-primary"></i> Crear Nuevo Tema
 </h1>
    <p class="text-muted mb-0">Comparte tus ideas con la comunidad</p>
      </div>
     </div>

    <!-- Alertas de Validación -->
  <partial name="_ValidationSummaryPartial" />

      <!-- Formulario -->
     <div class="card shadow-sm">
        <div class="card-body p-4">
  <form asp-action="Create" method="post" id="createForm">
<div asp-validation-summary="ModelOnly" class="alert alert-danger d-none"></div>

  <!-- Título -->
    <div class="mb-4">
  <label asp-for="Titulo" class="form-label fw-bold">
      <i class="bi bi-chat-text"></i> Título del Tema
       <span class="text-danger">*</span>
    </label>
   <input asp-for="Titulo" 
     class="form-control form-control-lg" 
 placeholder="Ej: ¿Cómo implementar Identity en ASP.NET Core 8?"
     maxlength="250"
      id="tituloInput"
       autocomplete="off">
  <span asp-validation-for="Titulo" class="invalid-feedback"></span>
 <div class="form-text d-flex justify-content-between">
       <span>
       <i class="bi bi-info-circle"></i> 
      Sé específico y descriptivo
      </span>
<span class="char-counter" id="tituloCounter">0/250</span>
    </div>
  </div>

     <!-- Categoría -->
   <div class="mb-4">
  <label asp-for="CategoriaId" class="form-label fw-bold">
  <i class="bi bi-folder"></i> Categoría
  <span class="text-danger">*</span>
       </label>
      <select asp-for="CategoriaId" 
      class="form-select form-select-lg" 
       asp-items="ViewBag.Categorias"
    id="categoriaSelect">
  <option value="">-- Selecciona una categoría --</option>
      </select>
   <span asp-validation-for="CategoriaId" class="invalid-feedback"></span>
     <div class="form-text">
      <i class="bi bi-info-circle"></i> 
   Ayuda a otros a encontrar tu tema
        </div>
    </div>

   <!-- Contenido -->
 <div class="mb-4">
    <label asp-for="Contenido" class="form-label fw-bold">
    <i class="bi bi-file-text"></i> Contenido
    <span class="text-danger">*</span>
     </label>
       <textarea asp-for="Contenido" 
  class="form-control" 
  rows="10"
  placeholder="Describe tu pregunta o tema en detalle...&#10;&#10;Puedes incluir:&#10;- Contexto del problema&#10;- Lo que has intentado&#10;- Código relevante&#10;- Errores específicos"
 maxlength="5000"
       id="contenidoTextarea"></textarea>
    <span asp-validation-for="Contenido" class="invalid-feedback"></span>
   <div class="form-text d-flex justify-content-between">
     <span>
      <i class="bi bi-info-circle"></i> 
     Mínimo 10 caracteres, máximo 5000
      </span>
 <span class="char-counter" id="contenidoCounter">0/5000</span>
       </div>
 </div>

     <!-- Vista Previa -->
  <div class="mb-4">
 <button type="button" class="btn btn-outline-secondary" id="togglePreview">
      <i class="bi bi-eye"></i> Vista Previa
 </button>
     </div>

   <div class="card preview-card mb-4" id="previewCard">
    <div class="card-header bg-light">
<i class="bi bi-eye"></i> Vista Previa
  </div>
        <div class="card-body">
     <div class="mb-2">
        <span class="badge bg-secondary" id="previewCategoria">Categoría</span>
      </div>
     <h4 id="previewTitulo" class="text-muted">Título de tu tema...</h4>
    <hr>
     <div id="previewContenido" class="text-muted">El contenido aparecerá aquí...</div>
 </div>
      </div>

   <!-- Botones -->
     <div class="d-flex gap-2 justify-content-between">
    <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
       <i class="bi bi-x-circle"></i> Cancelar
  </a>
         <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
  <i class="bi bi-check-circle"></i> Crear Tema
       </button>
 </div>

 <input type="hidden" asp-for="UsuarioId" />
    </form>
  </div>
 </div>

      <!-- Consejos -->
     <div class="card mt-4 border-info">
        <div class="card-header bg-info bg-opacity-10 border-info">
    <h6 class="mb-0">
    <i class="bi bi-lightbulb text-info"></i> Consejos para un Buen Tema
     </h6>
    </div>
     <div class="card-body">
  <ul class="mb-0 small">
 <li class="mb-2">
      <strong>Busca primero:</strong> Verifica si tu pregunta ya fue respondida
     </li>
<li class="mb-2">
     <strong>Sé específico:</strong> Un título claro ayuda a obtener mejores respuestas
 </li>
   <li class="mb-2">
 <strong>Incluye detalles:</strong> Contexto, código y errores son muy útiles
    </li>
    <li class="mb-2">
      <strong>Formatea el código:</strong> Usa bloques de código para mejor legibilidad
       </li>
 <li class="mb-0">
   <strong>Sé respetuoso:</strong> Mantén un tono profesional y amigable
   </li>
    </ul>
 </div>
 </div>
 </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
  $(document).ready(function() {
   // Contador de caracteres para título
     $('#tituloInput').on('input', function() {
 var length = $(this).val().length;
       var counter = $('#tituloCounter');
     counter.text(length + '/250');
            
    if (length > 225) {
   counter.addClass('danger');
    } else if (length > 200) {
       counter.addClass('warning').removeClass('danger');
    } else {
     counter.removeClass('warning danger');
     }
    });

       // Contador de caracteres para contenido
 $('#contenidoTextarea').on('input', function() {
   var length = $(this).val().length;
       var counter = $('#contenidoCounter');
      counter.text(length + '/5000');
       
  if (length > 4500) {
     counter.addClass('danger');
  } else if (length > 4000) {
    counter.addClass('warning').removeClass('danger');
    } else {
   counter.removeClass('warning danger');
      }
 });

// Toggle vista previa
       $('#togglePreview').click(function() {
    var preview = $('#previewCard');
     var icon = $(this).find('i');
    
      if (preview.is(':visible')) {
preview.slideUp();
     icon.removeClass('bi-eye-slash').addClass('bi-eye');
     $(this).html('<i class="bi bi-eye"></i> Vista Previa');
  } else {
     updatePreview();
     preview.slideDown();
   icon.removeClass('bi-eye').addClass('bi-eye-slash');
       $(this).html('<i class="bi bi-eye-slash"></i> Ocultar Vista Previa');
     }
        });

   // Actualizar vista previa
  function updatePreview() {
  var titulo = $('#tituloInput').val() || 'Título de tu tema...';
     var contenido = $('#contenidoTextarea').val() || 'El contenido aparecerá aquí...';
    var categoriaText = $('#categoriaSelect option:selected').text();
      
   $('#previewTitulo').text(titulo);
   $('#previewContenido').text(contenido);
     $('#previewCategoria').text(categoriaText !== '-- Selecciona una categoría --' ? categoriaText : 'Categoría');
    }

  // Actualizar preview en tiempo real
    $('#tituloInput, #contenidoTextarea, #categoriaSelect').on('input change', function() {
       if ($('#previewCard').is(':visible')) {
   updatePreview();
       }
   });

 // Validación antes de enviar
      $('#createForm').submit(function(e) {
    var titulo = $('#tituloInput').val().trim();
    var contenido = $('#contenidoTextarea').val().trim();
    var categoria = $('#categoriaSelect').val();
            
    if (titulo.length < 5) {
  e.preventDefault();
         alert('El título debe tener al menos 5 caracteres');
   $('#tituloInput').focus();
        return false;
       }
            
if (contenido.length < 10) {
 e.preventDefault();
      alert('El contenido debe tener al menos 10 caracteres');
     $('#contenidoTextarea').focus();
     return false;
       }
            
    if (!categoria) {
      e.preventDefault();
    alert('Debes seleccionar una categoría');
  $('#categoriaSelect').focus();
      return false;
   }

// Deshabilitar botón de envío para evitar doble submit
       $('#submitBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Creando...');
        });

       // Auto-save en localStorage (opcional)
        var autoSaveKey = 'tema_draft_' + @(User.Identity?.Name ?? "guest");
        
        // Cargar draft si existe
        var draft = localStorage.getItem(autoSaveKey);
    if (draft) {
     var data = JSON.parse(draft);
if (confirm('Se encontró un borrador guardado. ¿Deseas cargarlo?')) {
       $('#tituloInput').val(data.titulo);
    $('#contenidoTextarea').val(data.contenido);
    $('#categoriaSelect').val(data.categoria);
 localStorage.removeItem(autoSaveKey);
       }
  }

  // Guardar draft cada 30 segundos
  setInterval(function() {
   var titulo = $('#tituloInput').val();
       var contenido = $('#contenidoTextarea').val();
       var categoria = $('#categoriaSelect').val();
 
            if (titulo || contenido) {
        var draft = {
titulo: titulo,
        contenido: contenido,
      categoria: categoria
  };
      localStorage.setItem(autoSaveKey, JSON.stringify(draft));
      }
 }, 30000);
    });
    </script>
}
