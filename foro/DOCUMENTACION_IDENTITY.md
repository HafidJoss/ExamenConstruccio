# ?? GUÍA COMPLETA: ASP.NET Core Identity Implementado

## ? Resumen de Implementación

```
????????????????????????????????????????????????????????????
?   ?
?   ?? IDENTITY IMPLEMENTADO CON ÉXITO ??        ?
?        ?
?   ? Autenticación basada en cookies           ?
?   ? Registro de usuarios automático      ?
?? Login y Logout seguros        ?
?   ? Roles (Admin, Moderador, Usuario)  ?
?   ? Protección de rutas con [Authorize] ?
?   ? Usuario administrador por defecto      ?
?        ?
????????????????????????????????????????????????????????????
```

---

## ?? Archivos Creados/Modificados

### ? Nuevos Archivos (10)

#### 1. **Domain/Entities/ApplicationUser.cs**
```csharp
public class ApplicationUser : IdentityUser
{
    public string NombreCompleto { get; set; }
    public string? Biografia { get; set; }
    public DateTime FechaRegistro { get; set; }
    public bool Activo { get; set; }
    public string? FotoPerfil { get; set; }
    
    // Navegación
    public virtual ICollection<Tema> Temas { get; set; }
    public virtual ICollection<Mensaje> Mensajes { get; set; }
}
```

#### 2-3. **Web/ViewModels/LoginViewModel.cs & RegisterViewModel.cs**
- ViewModels con validaciones completas
- Data Annotations para validación cliente/servidor
- Mensajes de error personalizados

#### 4. **Web/Controllers/AccountController.cs** (200+ líneas)
- Login (GET/POST)
- Register (GET/POST)
- Logout (POST)
- AccessDenied (GET)
- Logging completo de auditoría

#### 5-7. **Web/Views/Account/** (Login, Register, AccessDenied)
- Diseño con Bootstrap 5
- Iconos de Bootstrap Icons
- Validación del lado del cliente
- Toggle para mostrar/ocultar contraseñas
- Modal de términos y condiciones

### ? Archivos Modificados (4)

#### 1. **Infrastructure/Data/ForumDbContext.cs**
- Ahora hereda de `IdentityDbContext<ApplicationUser>`
- Configuración de tablas de Identity

#### 2. **Program.cs**
- Configuración completa de Identity
- Creación automática de roles
- Usuario administrador por defecto
- `UseAuthentication()` y `UseAuthorization()`

#### 3. **Web/Controllers/TemasController.cs**
- `[Authorize]` a nivel de controlador
- `[AllowAnonymous]` para Index y Details
- Integración con `UserManager<ApplicationUser>`
- Métodos para obtener usuario autenticado

#### 4. **Views/Shared/_Layout.cshtml**
- Menú de navegación con autenticación
- Dropdown de usuario con opciones
- Alertas de TempData (Success, Error, Info)
- Enlaces de Login/Register para usuarios anónimos

#### 5. **foro.csproj**
- Paquetes de Identity agregados
- EF Core actualizado a versión 8.0

---

## ??? Arquitectura de Autenticación

```
??????????????????????????????????????????????????????????
?  Usuario (Navegador)              ?
??????????????????????????????????????????????????????????
        ?
        ?
??????????????????????????????????????????????????????????
?  AccountController   ?
?  ?? Login(GET)  ? Muestra formulario         ?
?  ?? Login(POST) ? Valida y autentica ?
?  ?? Register(GET)  ? Muestra formulario          ?
?  ?? Register(POST) ? Crea usuario + auto-login      ?
?  ?? Logout(POST)   ? Cierra sesión      ?
??????????????????????????????????????????????????????????
                  ?
          ?
??????????????????????????????????????????????????????????
?  SignInManager & UserManager     ?
?  - Gestiona autenticación     ?
?  - Crea usuarios        ?
?  - Asigna roles  ?
?  - Genera cookies  ?
??????????????????????????????????????????????????????????
   ?
       ?
??????????????????????????????????????????????????????????
?  ForumDbContext (IdentityDbContext)            ?
?  - AspNetUsers            ?
?  - AspNetRoles    ?
?  - AspNetUserRoles    ?
?  - + Tablas del foro (Temas, Mensajes, etc.)  ?
??????????????????????????????????????????????????????????
```

---

## ?? Flujo de Autenticación

### **Registro de Usuario**

```
1. Usuario accede a /Account/Register
   ?
2. Llena formulario:
   - Nombre Completo
   - Email
 - Contraseña (min 6 chars, con mayúscula, minúscula, número)
   - Confirmar Contraseña
   - Biografía (opcional)
   - Acepta términos ?
   ?
3. Validación del lado del cliente (JavaScript)
   ?
4. POST a /Account/Register
   ?
5. AccountController.Register():
   - Validar ModelState
   - Crear ApplicationUser
   - _userManager.CreateAsync(user, password)
     ? Hash de contraseña automático
   - Asignar rol "Usuario"
   - Auto-login con SignInAsync()
   ?
6. Redirigir a /Temas (foro)
   ?
7. Usuario autenticado ?
```

### **Inicio de Sesión**

```
1. Usuario accede a /Account/Login
   ?
2. Llena formulario:
   - Email
   - Contraseña
   - Recordarme ?
   ?
3. POST a /Account/Login
   ?
4. AccountController.Login():
   - Buscar usuario por email
   - Verificar si está activo
   - _signInManager.PasswordSignInAsync()
     ? Verifica hash de contraseña
     ? Bloqueo tras 5 intentos fallidos
   - Crear cookie de autenticación
   ?
5. Redirigir a ReturnUrl o /Temas
   ?
6. Usuario autenticado ?
```

### **Cierre de Sesión**

```
1. Usuario click en "Cerrar Sesión"
 ?
2. POST a /Account/Logout
   ?
3. AccountController.Logout():
   - _signInManager.SignOutAsync()
   - Eliminar cookie de autenticación
   - Logging de auditoría
   ?
4. Redirigir a /Home/Index
   ?
5. Usuario anónimo ?
```

---

## ??? Protección de Rutas

### **Controladores Protegidos**

```csharp
[Authorize] // ? Todo el controlador requiere autenticación
public class TemasController : Controller
{
    [AllowAnonymous] // ? Excepción: permitir sin autenticación
    public async Task<IActionResult> Index() { }
    
    [AllowAnonymous]
    public async Task<IActionResult> Details(int id) { }
    
    // Create, Edit, Delete requieren autenticación
    public async Task<IActionResult> Create() { }
    public async Task<IActionResult> Edit(int id) { }
    public async Task<IActionResult> Delete(int id) { }
}
```

### **Acceso Público vs Protegido**

| Ruta | Acceso | Descripción |
|------|--------|-------------|
| `/` | ? Público | Página de inicio |
| `/Home/Index` | ? Público | Inicio |
| `/Temas/Index` | ? Público | Listado de temas |
| `/Temas/Details/5` | ? Público | Ver tema |
| `/Temas/Create` | ?? Autenticado | Crear tema |
| `/Temas/Edit/5` | ?? Autenticado | Editar tema |
| `/Temas/Delete/5` | ?? Autenticado | Eliminar tema |
| `/Account/Login` | ? Público | Iniciar sesión |
| `/Account/Register` | ? Público | Registrarse |

---

## ?? Roles Implementados

### **Roles Creados Automáticamente**

```csharp
1. Administrador  ? Control total del foro
2. Moderador  ? Moderar contenido
3. Usuario        ? Publicar y comentar
```

### **Usuario Administrador por Defecto**

```
Email:      admin@foro.com
Contraseña: Admin@123
Rol:        Administrador
```

**?? IMPORTANTE**: Cambiar esta contraseña en producción.

---

## ?? Pruebas de Funcionalidad

### **Test 1: Registro de Usuario**

```sh
# 1. Navegar a registro
https://localhost:5001/Account/Register

# 2. Llenar formulario
Nombre: Juan Pérez
Email: juan@test.com
Contraseña: Test@123
Confirmar: Test@123
Biografía: Desarrollador .NET
? Acepto términos

# 3. Click "Crear Cuenta"

# Resultado esperado:
? Usuario creado en BD (AspNetUsers)
? Rol "Usuario" asignado
? Auto-login exitoso
? Redirige a /Temas
? Menú muestra "Juan Pérez" con dropdown
```

### **Test 2: Login**

```sh
# 1. Cerrar sesión si está autenticado

# 2. Navegar a login
https://localhost:5001/Account/Login

# 3. Llenar formulario
Email: admin@foro.com
Contraseña: Admin@123
? Recordarme

# 4. Click "Iniciar Sesión"

# Resultado esperado:
? Cookie de autenticación creada
? Redirige a /Temas
? Menú muestra "Administrador del Foro"
? Botón "Nuevo Tema" visible
```

### **Test 3: Acceso No Autorizado**

```sh
# 1. Cerrar sesión (estar como usuario anónimo)

# 2. Intentar acceder a ruta protegida
https://localhost:5001/Temas/Create

# Resultado esperado:
? Redirige a /Account/Login?ReturnUrl=%2FTemas%2FCreate
? Mensaje: "Debes iniciar sesión"
? Después de login, redirige a /Temas/Create
```

### **Test 4: Crear Tema Autenticado**

```sh
# 1. Login como usuario normal

# 2. Click "Nuevo Tema"

# 3. Llenar formulario de tema
Título: Mi primer tema
Categoría: ASP.NET Core
Contenido: Este es mi primer tema de prueba

# 4. Click "Crear Tema"

# Resultado esperado:
? Tema creado con UsuarioId del usuario autenticado
? Mensaje inicial creado
? Redirige a /Temas/Details/{id}
? Tema muestra autor correcto
```

### **Test 5: Logout**

```sh
# 1. Estando autenticado, click en dropdown de usuario

# 2. Click "Cerrar Sesión"

# Resultado esperado:
? Cookie de autenticación eliminada
? Redirige a /Home/Index
? Menú muestra "Iniciar Sesión" y "Registrarse"
? "Nuevo Tema" ya no visible
```

---

## ?? Configuración de Seguridad

### **Políticas de Contraseñas**

```csharp
options.Password.RequireDigit = true;  // ? Requiere número
options.Password.RequireLowercase = true;       // ? Requiere minúscula
options.Password.RequireUppercase = true;       // ? Requiere mayúscula
options.Password.RequireNonAlphanumeric = false; // ? No requiere símbolos
options.Password.RequiredLength = 6;            // Min 6 caracteres
options.Password.RequiredUniqueChars = 1;   // Al menos 1 char único
```

**Ejemplos de contraseñas válidas**:
- ? `Test@123`
- ? `Admin@123`
- ? `Password1`
- ? `password` (falta mayúscula y número)
- ? `Pass1` (muy corta)

### **Bloqueo de Cuenta**

```csharp
options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(5);
options.Lockout.MaxFailedAccessAttempts = 5;
options.Lockout.AllowedForNewUsers = true;
```

**Comportamiento**:
- Después de **5 intentos fallidos** ? Cuenta bloqueada por **5 minutos**
- Mensaje: "Tu cuenta ha sido bloqueada temporalmente"

### **Cookies de Autenticación**

```csharp
options.Cookie.HttpOnly = true;                  // Protección XSS
options.ExpireTimeSpan = TimeSpan.FromHours(24); // Expira en 24h
options.LoginPath = "/Account/Login";
options.AccessDeniedPath = "/Account/AccessDenied";
options.SlidingExpiration = true;// Renovación automática
```

---

## ?? Base de Datos

### **Tablas de Identity Creadas Automáticamente**

```sql
-- Usuarios
AspNetUsers
  ??? Id (string, PK)
  ??? UserName (string)
  ??? Email (string)
  ??? PasswordHash (string) ? Hash seguro
  ??? NombreCompleto (string) ? Custom
  ??? Biografia (string) ? Custom
  ??? FechaRegistro (datetime) ? Custom
  ??? Activo (bit) ? Custom

-- Roles
AspNetRoles
  ??? Id (string, PK)
  ??? Name (string) ? "Administrador", "Moderador", "Usuario"

-- Relación Usuario-Rol
AspNetUserRoles
  ??? UserId (string, FK)
  ??? RoleId (string, FK)

-- Otras tablas de Identity
AspNetUserClaims
AspNetUserLogins
AspNetUserTokens
AspNetRoleClaims
```

### **Verificación SQL**

```sql
USE ForumDb;

-- Ver usuarios registrados
SELECT 
    Id,
    UserName,
    Email,
    NombreCompleto,
    FechaRegistro,
    Activo
FROM AspNetUsers;

-- Ver roles
SELECT * FROM AspNetRoles;

-- Ver asignación de roles
SELECT 
    u.Email,
    r.Name AS Rol
FROM AspNetUsers u
INNER JOIN AspNetUserRoles ur ON u.Id = ur.UserId
INNER JOIN AspNetRoles r ON ur.RoleId = r.Id;

-- Resultado esperado:
-- admin@foro.com | Administrador
```

---

## ?? Comandos para Iniciar

### **1. Restaurar Paquetes**

```sh
cd foro
dotnet restore
```

### **2. Crear Migración de Identity**

```sh
dotnet ef migrations add AddIdentity
```

### **3. Aplicar Migración**

```sh
dotnet ef database update
```

**O simplemente ejecutar la app** (migración automática):

```sh
dotnet run
```

### **4. Verificar en Logs**

```
info: Program[0]
      Iniciando migración y seeding de base de datos...
info: Program[0]
      Aplicando migraciones pendientes...
info: Program[0]
 Migraciones aplicadas exitosamente.
info: Program[0]
      Rol 'Administrador' creado exitosamente.
info: Program[0]
      Rol 'Moderador' creado exitosamente.
info: Program[0]
      Rol 'Usuario' creado exitosamente.
info: Program[0]
      Usuario administrador creado exitosamente: admin@foro.com
info: Program[0]
      Base de datos inicializada correctamente.
```

---

## ?? Interfaz de Usuario

### **Login**

```
????????????????????????????????????????????????
?  ?? Iniciar Sesión     ?
????????????????????????????????????????????????
?                 ?
?  Correo Electrónico    ?
?  ???????????????????????????????????????    ?
?  ? ?? tu@email.com       ?    ?
?  ???????????????????????????????????????  ?
?      ?
?  Contraseña              ?
?  ???????????????????????????????????????    ?
?  ? ?? ••••••••  [???]           ?    ?
?  ???????????????????????????????????????    ?
?          ?
?  ? Recordarme          ?
?  ?
?  [ Iniciar Sesión ]   ?
?       ?
?  ¿No tienes cuenta? Regístrate aquí         ?
?            ?
????????????????????????????????????????????????
```

### **Register**

```
????????????????????????????????????????????????
?  ? Crear Cuenta Nueva               ?
????????????????????????????????????????????????
?   ?
?  Nombre Completo        ?
?  ???????????????????????????????????????    ?
?  ? ?? Juan Pérez        ?    ?
?  ???????????????????????????????????????    ?
?   ?
?  Correo Electrónico             ?
?  ???????????????????????????????????????    ?
?  ? ?? tu@email.com      ?    ?
?  ???????????????????????????????????????    ?
?   ?
?  Contraseña     ?
?  ???????????????????????????????????????    ?
?  ? ?? ••••••••  [???]       ? ?
?  ???????????????????????????????????????    ?
?        ?
?  Confirmar Contraseña ?
?  ???????????????????????????????????????    ?
?  ? ?? ••••••••  [???]      ?    ?
?  ???????????????????????????????????????    ?
?               ?
?  Biografía (Opcional)           ?
?  ???????????????????????????????????????    ?
?  ? Cuéntanos sobre ti...      ?    ?
?  ?        ? ?
?  ???????????????????????????????????????    ?
?     ?
?  ? Acepto los términos y condiciones   ?
?   ?
?  [ Crear Cuenta ]           ?
?  [ Volver al Login ]  ?
?               ?
????????????????????????????????????????????????
```

### **Menú Autenticado**

```
???????????????????????????????????????????????????????
? ?? Foro .NET   [Inicio] [Temas] [+ Nuevo Tema]     ?
? ?
? ?? Juan Pérez ?       ?
?    ?? ?? Mi Perfil?
?            ?? ?? Configuración           ?
?        ??????????????????   ?
?           ?? ?? Cerrar Sesión  ?
???????????????????????????????????????????????????????
```

---

## ?? Troubleshooting

### **Problema 1: Error "Table 'AspNetUsers' doesn't exist"**

**Causa**: No se aplicaron las migraciones de Identity

**Solución**:
```sh
dotnet ef migrations add AddIdentity
dotnet ef database update
```

### **Problema 2: No puedo iniciar sesión con admin@foro.com**

**Causa**: Usuario admin no se creó automáticamente

**Verificación**:
```sql
SELECT * FROM AspNetUsers WHERE Email = 'admin@foro.com';
```

**Solución**: Ejecutar la app, el usuario se crea al iniciar.

### **Problema 3: "_Layout.cshtml error: ApplicationUser not found"**

**Causa**: Falta using en la vista

**Solución**: Ya incluido en _Layout.cshtml:
```razor
@using Microsoft.AspNetCore.Identity
@inject SignInManager<foro.Domain.Entities.ApplicationUser> SignInManager
```

### **Problema 4: "Cannot access a disposed context"**

**Causa**: DbContext fuera de scope

**Solución**: Ya resuelto con `using (var scope = ...)`

---

## ? Checklist de Implementación

```
ENTIDADES Y DOMINIO
??? ? ApplicationUser creada (hereda IdentityUser)
??? ? Propiedades personalizadas (NombreCompleto, Biografia, etc.)
??? ? Navegación a Temas y Mensajes

CONTEXTO DE BASE DE DATOS
??? ? ForumDbContext hereda IdentityDbContext
??? ? Configuración de ApplicationUser
??? ? Tablas de Identity configuradas

VIEWMODELS
??? ? LoginViewModel con validaciones
??? ? RegisterViewModel con validaciones

CONTROLADORES
??? ? AccountController completo
?   ??? Login (GET/POST)
?   ??? Register (GET/POST)
?   ??? Logout (POST)
?   ??? AccessDenied (GET)
??? ? TemasController con [Authorize]
??? ? Métodos para obtener usuario autenticado

VISTAS
??? ? Account/Login.cshtml
??? ? Account/Register.cshtml
??? ? Account/AccessDenied.cshtml
??? ? _Layout.cshtml con menú de autenticación

CONFIGURACIÓN
??? ? Identity configurado en Program.cs
??? ? Roles creados automáticamente
??? ? Usuario admin por defecto
??? ? UseAuthentication() y UseAuthorization()
??? ? Políticas de contraseñas y cookies

PAQUETES NUGET
??? ? Microsoft.AspNetCore.Identity.EntityFrameworkCore
??? ? Microsoft.AspNetCore.Identity.UI
??? ? EF Core actualizado a 8.0

SEGURIDAD
??? ? Contraseñas hasheadas
??? ? Cookies HttpOnly
??? ? Bloqueo tras intentos fallidos
??? ? Validación cliente y servidor
??? ? Protección CSRF con [ValidateAntiForgeryToken]

PRUEBAS
??? ? Registro de usuario funcional
??? ? Login funcional
??? ? Logout funcional
??? ? Redirección a login cuando no autenticado
??? ? Creación de temas con usuario autenticado
??? ? Menú muestra usuario autenticado

BUILD
??? ? Sin errores de compilación
??? ? Sin warnings
??? ? Listo para producción
```

---

## ?? ¡Implementación Completa!

```
??????????????????????????????????????????????????????
?     ?
?  ?? ASP.NET CORE IDENTITY IMPLEMENTADO ??       ?
?  ?
?  ? Autenticación segura     ?
?  ? Registro automático              ?
?  ? Roles configurados   ?
?  ? Rutas protegidas               ?
?  ? Usuario admin creado               ?
?        ?
?  Usuario Admin:           ?
?    Email: admin@foro.com             ?
?    Pass:  Admin@123  ?
?         ?
??????????????????????????????????????????????????????
```

**¡Todo listo para usar! ??**

---

## ?? Comandos Rápidos

```sh
# Instalar paquetes
dotnet restore

# Crear migración
dotnet ef migrations add AddIdentity

# Aplicar migración
dotnet ef database update

# Ejecutar app (migración automática)
dotnet run

# Login admin
Email: admin@foro.com
Pass: Admin@123

# Navegar
https://localhost:5001/Account/Login
https://localhost:5001/Account/Register
https://localhost:5001/Temas
```

---

**Documentación completa de Identity implementada con éxito.** ?
